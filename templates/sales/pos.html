{% extends "base.html" %}

{% block content %}
<style>
    /* All the CSS styles from the design */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
        background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
        min-height: 100vh;
        padding: 20px;
        color: #333;
    }
    
    .container {
        max-width: 1400px;
        margin: 0 auto;
        background-color: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        overflow: hidden;
    }
    
    header {
        background: linear-gradient(to right, #2c3e50, #4a6491);
        color: white;
        padding: 20px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .logo {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .logo i {
        font-size: 2.2rem;
        color: #fdbb2d;
    }
    
    .logo h1 {
        font-size: 1.8rem;
    }
    
    .pos-info {
        display: flex;
        gap: 25px;
        font-size: 1.1rem;
    }
    
    .pos-info div {
        background: rgba(255, 255, 255, 0.15);
        padding: 8px 15px;
        border-radius: 8px;
    }
    
    .pos-content {
        display: flex;
        padding: 20px;
        gap: 25px;
    }
    
    .products-section {
        flex: 1;
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    }
    
    .search-container {
        display: flex;
        gap: 15px;
        margin-bottom: 25px;
        align-items: center;
    }

    .search-bar-container {
        flex: 1;
        position: relative;
        min-width: 0;
    }

    .search-bar {
        width: 100%;
        padding: 15px 20px 15px 50px;
        font-size: 1.1rem;
        border: 2px solid #234;
        border-radius: 50px;
        transition: 0.3s ease all;
        background: white;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.05);
    }
    
     .search-bar:focus {
        outline: none;
        border-color: #4a6491;
        box-shadow: 0 0 0 3px rgba(74, 100, 145, 0.2);
    } 
        
    .search-icon {
        position: absolute;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        color: #777;
        font-size: 1.2rem;
    }

    .search-btn {
        padding: 12px 25px;
        font-size: 1rem;
        font-weight: 600;
        border: none;
        border-radius: 50px;
        background: linear-gradient(to right, #3498db, #2980b9);
        color: white;
        cursor: pointer;
        flex-shrink: 0;
        white-space: nowrap;
        box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3);
        transition: 0.3s ease all;
        width: auto;
    }

    .search-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(52, 152, 219, 0.4);
    }
    
    .item-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
    }
    
    .item-table th {
        background: linear-gradient(to bottom, #4a6491, #2c3e50);
        color: white;
        padding: 15px 10px;
        text-align: left;
        font-weight: 600;
    }
    
    .item-table td {
        padding: 12px 10px;
        border-bottom: 1px solid #eee;
    }
    
    .item-table tr:last-child td {
        border-bottom: none;
    }
    
    .item-table tr:hover {
        background-color: #f5f9ff;
    }
    
    .add-to-cart {
        background: linear-gradient(to right, #2ecc71, #27ae60);
        color: white;
        border: none;
        border-radius: 5px;
        padding: 8px 15px;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .add-to-cart:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(46, 204, 113, 0.3);
    }
    
    .cart-section {
        width: 40%;
        min-width: 400px;
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        display: flex;
        flex-direction: column;
    }
    
    .cart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .cart-header h3 {
        font-size: 1.5rem;
        color: #2c3e50;
    }
    
    .clear-cart {
        background: linear-gradient(to right, #e74c3c, #c0392b);
        color: white;
        border: none;
        border-radius: 5px;
        padding: 8px 15px;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .clear-cart:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
    }
    
    #cart-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
    }
    
    #cart-table th {
        background: linear-gradient(to bottom, #4a6491, #2c3e50);
        color: white;
        padding: 12px 10px;
        text-align: left;
        font-weight: 600;
    }
    
    #cart-table td {
        padding: 10px;
        border-bottom: 1px solid #eee;
    }
    
    #cart-table input[type="number"] {
        width: 60px;
        padding: 6px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .remove-item {
        background: #e74c3c;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 5px 10px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .remove-item:hover {
        background: #c0392b;
    }
    
    .cart-total {
        background: white;
        padding: 15px;
        border-radius: 10px;
        text-align: right;
        font-size: 1.3rem;
        font-weight: 700;
        color: #2c3e50;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        margin-top: auto;
    }
    
    .cart-total span {
        color: #27ae60;
    }
    
    .payment-section {
        background: white;
        padding: 20px;
        border-radius: 10px;
        margin-top: 20px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
    }
    
    .payment-method {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    }
    
    .payment-method label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-size: 1.1rem;
    }
    
    .payment-method input {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }
    
    #mpesa-field {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
    }
    
    #mpesa-field label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
    }
    
    #mpesa-field input {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
    }
    
    .checkout-btn {
        width: 100%;
        padding: 16px;
        background: linear-gradient(to right, #9b59b6, #8e44ad);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 1.2rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 6px 15px rgba(142, 68, 173, 0.4);
    }
    
    .checkout-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(142, 68, 173, 0.6);
    }
    
    .checkout-btn:active {
        transform: translateY(-1px);
    }
    
    .placeholder-row td {
        text-align: center;
        padding: 40px !important;
        color: #777;
        font-size: 1.1rem;
    }
    
    .empty-cart-row td {
        text-align: center;
        padding: 30px !important;
        color: #777;
        font-size: 1.1rem;
    }
    
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        background: #27ae60;
        color: white;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        transform: translateX(120%);
        transition: transform 0.4s ease;
        z-index: 1000;
    }
    
    .notification.show {
        transform: translateX(0);
    }
    
    @media (max-width: 992px) {
        .pos-content {
            flex-direction: column;
        }
        
        .cart-section {
            width: 100%;
            min-width: auto;
        }
    }
    
    @media (max-width: 576px) {
        .pos-info {
            flex-direction: column;
            gap: 10px;
        }
        
        .search-container {
            flex-direction: column;
        }
        
        .search-btn {
            padding: 12px;
        }
    }
</style>

<div class="container">
    <header>
        <div class="logo">
            <i class="fas fa-cash-register"></i>
            <h1>RetailPro POS</h1>
        </div>
        <div class="pos-info">
            <div><i class="fas fa-user"></i> Operator: {{ session['username'] }}</div>
            <div><i class="fas fa-store"></i> Store: Main Branch</div>
            <div><i class="fas fa-clock"></i> <span id="current-time"></span></div>
        </div>
    </header>
    
    <div class="pos-content">
        <div class="products-section">
            <div class="search-container">
                <div class="search-bar-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="search" placeholder="Search products by name..." class="search-bar">
                </div>
                <button class="search-btn">Search</button>
            </div>
            
            <table class="item-table">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Price</th>
                        <th>Size</th>
                        <th>Stock</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr id="placeholder-row" class="placeholder-row">
                        <td colspan="5">Enter a search term to display products</td>
                    </tr>
                    {% for item in items %}
                    <tr class="item-row" style="display: none;" 
                        data-id="{{ item.id }}" 
                        data-name="{{ item.name }}" 
                        data-price="{{ item.selling_price }}"
                        data-stock="{{ item.quantity }}"
                        data-size="{{ item.size if item.size else '-' }}">
                        <td>{{ item.name }}</td>
                        <td>KES {{ item.selling_price }}</td>
                        <td>{{ item.size if item.size else '-' }}</td>
                        <td>{{ item.quantity }}</td>
                        <td><button class="add-to-cart">Add to Cart</button></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="cart-section">
            <div class="cart-header">
                <h3><i class="fas fa-shopping-cart"></i> Shopping Cart</h3>
                <button class="clear-cart">Clear Cart</button>
            </div>
            
            <table id="cart-table">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Price</th>
                        <th>Qty</th>
                        <th>Total</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr id="empty-cart-row" class="empty-cart-row">
                        <td colspan="5">Your cart is empty</td>
                    </tr>
                </tbody>
            </table>
            
            <div class="cart-total">
                <strong>Total: KES <span id="total-amount">0.00</span></strong>
            </div>
            
            <form id="checkout-form" method="POST" action="{{ url_for('checkout') }}">
                <input type="hidden" name="cart" id="cart-data">
                <input type="hidden" name="total" id="total-value">
                
                <div class="payment-section">
                    <div class="payment-method">
                        <label><input type="radio" name="payment_method" value="cash" checked> Cash</label>
                        <label><input type="radio" name="payment_method" value="mpesa"> M-Pesa</label>
                    </div>
                    
                    <div id="mpesa-field">
                        <label>M-Pesa Code:</label>
                        <input type="text" name="mpesa_code" placeholder="Enter M-Pesa transaction code">
                    </div>
                    
                    <button type="submit" class="checkout-btn">Complete Sale <i class="fas fa-check-circle"></i></button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="notification" id="notification">
    Product added to cart successfully!
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const cart = [];
        
        // DOM elements
        const searchInput = document.getElementById('search');
        const searchBtn = document.querySelector('.search-btn');
        const placeholderRow = document.getElementById('placeholder-row');
        const itemRows = document.querySelectorAll('.item-row');
        const cartTableBody = document.querySelector('#cart-table tbody');
        const emptyCartRow = document.getElementById('empty-cart-row');
        const totalAmount = document.getElementById('total-amount');
        const clearCartBtn = document.querySelector('.clear-cart');
        const checkoutBtn = document.querySelector('.checkout-btn');
        const notification = document.getElementById('notification');
        const currentTime = document.getElementById('current-time');
        
        // Update current time
        function updateTime() {
            const now = new Date();
            currentTime.textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
        updateTime();
        setInterval(updateTime, 60000);
        
        // Search functionality
        function filterProducts() {
            const term = searchInput.value.trim().toLowerCase();
            let hasMatches = false;
            
            itemRows.forEach(row => {
                const name = row.dataset.name.toLowerCase();
                if (name.includes(term) && term.length > 0) {
                    row.style.display = 'table-row';
                    hasMatches = true;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Update placeholder
            if (term === '') {
                placeholderRow.style.display = 'table-row';
                placeholderRow.innerHTML = '<td colspan="5">Enter a search term to display products</td>';
            } else if (!hasMatches) {
                placeholderRow.style.display = 'table-row';
                placeholderRow.innerHTML = '<td colspan="5">No products found. Try a different search term.</td>';
            } else {
                placeholderRow.style.display = 'none';
            }
        }
        
        // Initial filter
        filterProducts();
        
        // Search functionality
        searchBtn.addEventListener('click', filterProducts);
        searchInput.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                filterProducts();
            }
        });
        
        // Add to cart functionality
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('add-to-cart')) {
                const row = e.target.closest('.item-row');
                const id = parseInt(row.dataset.id);
                const name = row.dataset.name;
                const price = parseFloat(row.dataset.price);
                const stock = parseInt(row.dataset.stock);
                
                // Check if already in cart
                const existing = cart.find(item => item.id === id);
                if (existing) {
                    if (existing.quantity < stock) {
                        existing.quantity++;
                    } else {
                        alert('Not enough stock');
                    }
                } else {
                    cart.push({id, name, price, quantity: 1, stock});
                }
                
                updateCart();
                showNotification();
            }
        });
        
        // Update cart display
        function updateCart() {
            // Clear existing cart rows
            while (cartTableBody.children.length > 1) {
                cartTableBody.removeChild(cartTableBody.lastChild);
            }
            
            let total = 0;
            
            if (cart.length > 0) {
                emptyCartRow.style.display = 'none';
                
                cart.forEach(item => {
                    const row = document.createElement('tr');
                    const itemTotal = item.price * item.quantity;
                    total += itemTotal;
                    
                    row.innerHTML = `
                        <td>${item.name}</td>
                        <td>KES ${item.price.toFixed(2)}</td>
                        <td>
                            <input type="number" min="1" max="${item.stock}" 
                                   value="${item.quantity}" data-id="${item.id}">
                        </td>
                        <td>KES ${itemTotal.toFixed(2)}</td>
                        <td><button class="remove-item" data-id="${item.id}">Remove</button></td>
                    `;
                    cartTableBody.appendChild(row);
                });
            } else {
                emptyCartRow.style.display = 'table-row';
            }
            
            totalAmount.textContent = total.toFixed(2);
            document.getElementById('total-value').value = total;
            document.getElementById('cart-data').value = JSON.stringify(cart);
        }
        
        // Remove item from cart
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-item')) {
                const id = parseInt(e.target.dataset.id);
                const index = cart.findIndex(item => item.id === id);
                
                if (index !== -1) {
                    cart.splice(index, 1);
                    updateCart();
                }
            }
        });
        
        // Update quantity
        document.addEventListener('change', function(e) {
            if (e.target.matches('input[type="number"]')) {
                const id = parseInt(e.target.dataset.id);
                const quantity = parseInt(e.target.value);
                const item = cart.find(item => item.id === id);
                
                if (item && quantity > 0 && quantity <= item.stock) {
                    item.quantity = quantity;
                    updateCart();
                } else if (item && quantity > item.stock) {
                    e.target.value = item.stock;
                    item.quantity = item.stock;
                    updateCart();
                }
            }
        });
        
        // Clear cart
        clearCartBtn.addEventListener('click', function() {
            cart.length = 0;
            updateCart();
        });
        
        // Payment method toggle
        document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.getElementById('mpesa-field').style.display = 
                    this.value === 'mpesa' ? 'block' : 'none';
            });
        });
        
        // Show notification
        function showNotification() {
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    });
</script>
{% endblock %}