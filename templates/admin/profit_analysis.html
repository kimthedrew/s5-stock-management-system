{% extends "base.html" %}

{% block content %}
<div class="profit-analysis-container">
    <div class="dashboard-header">
        <div class="header-left">
            <h2>Profit Analysis</h2>
        </div>
        <div class="header-controls">
            <button class="theme-toggle" id="themeToggle" title="Toggle Dark Mode">
                <i class="fas fa-moon"></i>
            </button>
            <button class="refresh-btn" id="refreshBtn" title="Refresh Analysis">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <div class="time-selector">
                <button class="time-btn {% if time_range == 'today' %}active{% endif %}" data-range="today">Today</button>
                <button class="time-btn {% if time_range == 'week' %}active{% endif %}" data-range="week">Week</button>
                <button class="time-btn {% if time_range == 'month' %}active{% endif %}" data-range="month">Month</button>
                <button class="time-btn {% if time_range == 'quarter' %}active{% endif %}" data-range="quarter">Quarter</button>
                <button class="time-btn {% if time_range == 'year' %}active{% endif %}" data-range="year">Year</button>
            </div>
        </div>
    </div>

    <div class="stats-cards">
        <div class="stat-card">
            <div class="title">Total Revenue</div>
            <div class="value">KES {{ total_revenue|default(0)|round(2) }}</div>
            <div class="label">All-time sales</div>
            <div class="trend {% if revenue_change >= 0 %}up{% else %}down{% endif %}">
                <i class="fas fa-arrow-{% if revenue_change >= 0 %}up{% else %}down{% endif %}"></i> 
                {{ revenue_change|default(0)|abs|round(1) }}% from last period
            </div>
        </div>
        <div class="stat-card">
            <div class="title">Total Items Sold</div>
            <div class="value">{{ (top_product.quantity_sold if top_product else 0)|default(0) }}</div>
            <div class="label">Across {{ (most_sold_per_day|length if most_sold_per_day else 0)|default(0) }} days</div>
        </div>
        <div class="stat-card">
            <div class="title">Total Profit</div>
            <div class="value">KES {{ total_profit|default(0)|round(2) }}</div>
            <div class="label">After expenses</div>
            <div class="trend {% if profit_change >= 0 %}up{% else %}down{% endif %}">
                <i class="fas fa-arrow-{% if profit_change >= 0 %}up{% else %}down{% endif %}"></i> 
                {{ profit_change|default(0)|abs|round(1) }}% from last period
            </div>
        </div>
        <div class="stat-card">
            <div class="title">Avg. Profit Margin</div>
            <div class="value">{{ profit_margin|default(0)|round(1) }}%</div>
            <div class="label">Per transaction</div>
            <div class="trend {% if margin_change >= 0 %}up{% else %}down{% endif %}">
                <i class="fas fa-arrow-{% if margin_change >= 0 %}up{% else %}down{% endif %}"></i>
                {{ margin_change|default(0)|abs|round(1) }}% from last period
            </div>
        </div>
        <div class="stat-card">
            <div class="title">Top Product</div>
            <div class="value">{{ top_product.name if top_product else 'N/A' }}</div>
            <div class="label">KES {{ (top_product.profit|round(2) if top_product else 0)|default(0) }} profit</div>
            <div class="trend {% if top_product and top_product.change >= 0 %}up{% else %}down{% endif %}">
                <i class="fas fa-arrow-{% if top_product and top_product.change >= 0 %}up{% else %}down{% endif %}"></i> 
                {{ (top_product.change|round(1) if top_product else 0)|default(0) }}% from last period
            </div>
        </div>
    </div>

    <!-- Today's Sold Items -->
    <div class="data-table">
        <div class="table-header">
            <h3>Today's Sold Items</h3>
            <div class="table-date" id="todays-date-display">{{ today_date|default("Today") }}</div>
        </div>
        <div class="table-content">
            <table>
                <thead>
                    <tr>
                        <th>Product Name</th>
                        <th>Quantity Sold</th>
                        <th>Unit Price</th>
                        <th>Total Revenue</th>
                        <th>Profit</th>
                    </tr>
                </thead>
                <tbody id="todaysSoldItems">
                    {% if todays_items and todays_items|length > 0 %}
                        {% for item in todays_items %}
                        <tr>
                            <td>{{ item.name|default('N/A') }}</td>
                            <td>{{ item.quantity|default(0) }}</td>
                            <td>KES {{ item.unit_price|default(0)|round(2) }}</td>
                            <td>KES {{ item.revenue|default(0)|round(2) }}</td>
                            <td class="positive">KES {{ item.profit|default(0)|round(2) }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr class="no-data">
                            <td colspan="5">No items sold today</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Daily Most Sold -->
    <div class="data-table">
        <div class="table-header">
            <h3>Daily Most Sold Item</h3>
        </div>
        <div class="table-content">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Product</th>
                        <th>Quantity Sold</th>
                    </tr>
                </thead>
                <tbody>
                    {% if most_sold_per_day and most_sold_per_day|length > 0 %}
                        {% for date, item_name in most_sold_per_day.items() %}
                        <tr>
                            <td>{{ date }}</td>
                            <td>{{ item_name }}</td>
                            <td>{{ daily_item_counts[date][item_name] if daily_item_counts and daily_item_counts[date] else 0 }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="3">No data available</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Weekly & Monthly Most Sold -->
    <div class="data-table">
        <div class="table-header">
            <h3>Top Performing Periods</h3>
        </div>
        <div class="table-content">
            <table>
                <thead>
                    <tr>
                        <th>Period</th>
                        <th>Product</th>
                        <th>Quantity Sold</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Weekly</td>
                        <td>{{ weekly_most_sold_name if weekly_most_sold_name else 'N/A' }}</td>
                        <td>{{ weekly_most_sold_qty if weekly_most_sold_qty else 0 }}</td>
                    </tr>
                    <tr>
                        <td>Monthly</td>
                        <td>{{ monthly_most_sold_name if monthly_most_sold_name else 'N/A' }}</td>
                        <td>{{ monthly_most_sold_qty if monthly_most_sold_qty else 0 }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-header">
            <h3>Revenue vs. Profit</h3>
            <div class="chart-controls">
                <button class="chart-btn" id="export-chart">
                    <i class="fas fa-download"></i> Export Chart
                </button>
                <button class="chart-btn" id="print-chart">
                    <i class="fas fa-print"></i> Print Chart
                </button>
            </div>
        </div>
        <div class="chart-wrapper">
            <canvas id="profitChart"></canvas>
        </div>
    </div>

    <div class="tables-container">
        <div class="data-table">
            <div class="table-header">
                <h3>Top Performing Products</h3>
            </div>
            <div class="table-content">
                <table>
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Revenue</th>
                            <th>Profit</th>
                            <th>Margin</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if top_products and top_products|length > 0 %}
                            {% for product in top_products %}
                            <tr>
                                <td>{{ product.name }}</td>
                                <td>KES {{ product.revenue|default(0)|round(2) }}</td>
                                <td>KES {{ product.profit|default(0)|round(2) }}</td>
                                <td class="positive">{{ product.margin|default(0)|round(1) }}%</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="4">No products found</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="data-table">
            <div class="table-header">
                <h3>Daily Summary</h3>
            </div>
            <div class="table-content">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Total Sales</th>
                            <th>Profit</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if profit_data and profit_data|length > 0 %}
                            {% for date, data in profit_data.items() %}
                            <tr>
                                <td>{{ date }}</td>
                                <td>KES {{ data.sales|default(0)|round(2) }}</td>
                                <td>KES {{ data.profit|default(0)|round(2) }}</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="3">No sales data available</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="actions">
        <button class="action-btn btn-export" id="exportButton">
            <i class="fas fa-file-export"></i> Export Full Report
        </button>
        <button class="action-btn btn-print" id="printButton">
            <i class="fas fa-print"></i> Print Report
        </button>
    </div>
</div>

<!-- Hidden JSON data -->
<div id="chart-data" data-chart='{{ chart_data | tojson | safe if chart_data else "{}" }}' style="display: none;"></div>

<!-- CSS Styles -->
<style>
    /* Your existing CSS remains the same */
    :root {
        --bg-primary: #f5f7f9;
        --bg-secondary: #ffffff;
        --text-primary: #333333;
        --text-secondary: #7f8c8d;
        --text-muted: #95a5a6;
        --border-color: #eaeaea;
        --shadow-light: 0 4px 20px rgba(0, 0, 0, 0.08);
        --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.05);
        --accent-blue: #3498db;
        --accent-green: #2ecc71;
        --accent-red: #e74c3c;
        --accent-orange: #f39c12;
        --accent-purple: #9b59b6;
        --header-bg: #f8f9fa;
    }

    [data-theme="dark"] {
        --bg-primary: #1a1d23;
        --bg-secondary: #2d3142;
        --text-primary: #ffffff;
        --text-secondary: #b8bcc8;
        --text-muted: #9ca3af;
        --border-color: #404040;
        --shadow-light: 0 4px 20px rgba(0, 0, 0, 0.3);
        --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.2);
        --header-bg: #374151;
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }
    
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--bg-primary);
        color: var(--text-primary);
        line-height: 1.6;
        padding: 20px;
        transition: background-color 0.3s ease, color 0.3s ease;
    }
    
    .profit-analysis-container {
        max-width: 1400px;
        margin: 0 auto;
        background: var(--bg-secondary);
        border-radius: 10px;
        box-shadow: var(--shadow-light);
        padding: 25px;
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }
    
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border-color);
        flex-wrap: wrap;
        gap: 15px;
    }
    
    .header-left h2 {
        color: var(--text-primary);
        font-size: 28px;
        font-weight: 600;
    }

    .header-controls {
        display: flex;
        align-items: center;
        gap: 20px;
        flex-wrap: wrap;
    }

    .theme-toggle {
        padding: 10px;
        background: var(--header-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        color: var(--text-primary);
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 40px;
        height: 40px;
    }

    .theme-toggle:hover {
        transform: scale(1.05);
        box-shadow: var(--shadow-medium);
    }

    [data-theme="dark"] .theme-toggle i::before {
        content: "\f185"; /* fa-sun */
    }

    .refresh-btn {
        padding: 10px 16px;
        background: var(--accent-green);
        border: 1px solid var(--accent-green);
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        color: white;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 100px;
        justify-content: center;
    }

    .refresh-btn:hover {
        background: #27ae60;
        border-color: #27ae60;
        transform: scale(1.05);
        box-shadow: var(--shadow-medium);
    }

    .refresh-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .refresh-btn i {
        transition: transform 0.3s ease;
    }

    .refresh-btn.loading i {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    .time-selector {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .time-btn {
        padding: 8px 16px;
        background: var(--header-bg);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        color: var(--text-primary);
        transition: all 0.2s;
    }
    
    .time-btn:hover {
        background: var(--accent-blue);
        color: white;
        border-color: var(--accent-blue);
    }
    
    .time-btn.active {
        background: var(--accent-blue);
        color: white;
        border-color: var(--accent-blue);
    }
    
    .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: var(--bg-secondary);
        border-radius: 10px;
        padding: 20px;
        box-shadow: var(--shadow-medium);
        border-left: 4px solid var(--accent-blue);
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-light);
    }
    
    .stat-card:nth-child(2) {
        border-left-color: var(--accent-green);
    }
    
    .stat-card:nth-child(3) {
        border-left-color: var(--accent-red);
    }
    
    .stat-card:nth-child(4) {
        border-left-color: var(--accent-orange);
    }
    
    .stat-card:nth-child(5) {
        border-left-color: var(--accent-purple);
    }
    
    .stat-card .title {
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: 8px;
    }
    
    .stat-card .value {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 5px;
        color: var(--text-primary);
    }
    
    .stat-card .label {
        font-size: 13px;
        color: var(--text-muted);
        margin-bottom: 10px;
    }
    
    .trend {
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .trend.up {
        color: var(--accent-green);
    }
    
    .trend.down {
        color: var(--accent-red);
    }
    
    .chart-container {
        margin-bottom: 30px;
        background: var(--bg-secondary);
        border-radius: 10px;
        overflow: hidden;
        box-shadow: var(--shadow-medium);
        transition: all 0.3s ease;
    }
    
    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
        flex-wrap: wrap;
        gap: 15px;
    }
    
    .chart-header h3 {
        color: var(--text-primary);
        font-size: 20px;
        font-weight: 600;
    }
    
    .chart-controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .chart-btn {
        padding: 8px 16px;
        background: var(--header-bg);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 5px;
        transition: all 0.2s;
    }
    
    .chart-btn:hover {
        background: var(--accent-blue);
        color: white;
        border-color: var(--accent-blue);
    }
    
    .chart-wrapper {
        position: relative;
        height: 450px;
        padding: 20px;
    }
    
    .tables-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }
    
    .data-table {
        background: var(--bg-secondary);
        border-radius: 10px;
        overflow: hidden;
        box-shadow: var(--shadow-medium);
        transition: all 0.3s ease;
    }

    .data-table:hover {
        box-shadow: var(--shadow-light);
    }
    
    .table-header {
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .table-header h3 {
        color: var(--text-primary);
        font-size: 18px;
        font-weight: 600;
    }

    .table-date {
        font-size: 14px;
        color: var(--text-secondary);
        font-weight: 500;
    }

    .table-content {
        max-height: 400px;
        overflow-y: auto;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
    }
    
    th, td {
        padding: 15px 20px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
    }
    
    th {
        background-color: var(--header-bg);
        font-weight: 600;
        color: var(--text-primary);
        position: sticky;
        top: 0;
        z-index: 1;
    }

    td {
        color: var(--text-primary);
    }
    
    tr:last-child td {
        border-bottom: none;
    }

    tr:hover {
        background-color: var(--header-bg);
    }

    .no-data {
        text-align: center;
        color: var(--text-muted);
        font-style: italic;
    }
    
    .positive {
        color: var(--accent-green);
        font-weight: 600;
    }
    
    .actions {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 40px;
        flex-wrap: wrap;
    }
    
    .action-btn {
        padding: 12px 24px;
        background: var(--accent-blue);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
        min-width: 160px;
        justify-content: center;
    }
    
    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
    }

    .action-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
    
    .btn-export {
        background: var(--accent-green);
    }
    
    .btn-export:hover:not(:disabled) {
        background: #27ae60;
    }
    
    .btn-print {
        background: var(--accent-purple);
    }
    
    .btn-print:hover:not(:disabled) {
        background: #8e44ad;
    }
    
    .chart-error {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--accent-red);
        text-align: center;
        padding: 20px;
    }
    
    .chart-error i {
        font-size: 48px;
        margin-bottom: 15px;
    }

    /* Loading state */
    .loading {
        position: relative;
        overflow: hidden;
    }

    .loading::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        animation: loading 1.5s infinite;
    }

    @keyframes loading {
        0% { left: -100%; }
        100% { left: 100%; }
    }

    /* Scrollbar styling for dark mode */
    [data-theme="dark"] ::-webkit-scrollbar {
        width: 8px;
    }

    [data-theme="dark"] ::-webkit-scrollbar-track {
        background: var(--bg-secondary);
    }

    [data-theme="dark"] ::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 4px;
    }

    [data-theme="dark"] ::-webkit-scrollbar-thumb:hover {
        background: var(--text-secondary);
    }
    
    @media (max-width: 992px) {
        .tables-container {
            grid-template-columns: 1fr;
        }
        
        .stats-cards {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
    }
    
    @media (max-width: 768px) {
        body {
            padding: 10px;
        }

        .profit-analysis-container {
            padding: 15px;
        }

        .dashboard-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .header-controls {
            width: 100%;
            justify-content: space-between;
        }
        
        .time-selector {
            flex-wrap: wrap;
        }
        
        .chart-header {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .actions {
            flex-direction: column;
        }

        .action-btn {
            width: 100%;
        }

        th, td {
            padding: 10px 15px;
            font-size: 14px;
        }
    }
    
    @media print {
        .time-selector, .chart-controls, .actions, .theme-toggle, .refresh-btn {
            display: none !important;
        }
        
        body {
            padding: 0;
            background: white !important;
            color: black !important;
        }
        
        .profit-analysis-container {
            box-shadow: none;
            padding: 0;
            background: white !important;
        }

        .stat-card, .data-table, .chart-container {
            background: white !important;
            color: black !important;
        }

        th, td {
            color: black !important;
            border-color: #ddd !important;
        }
    }
</style>

<!-- External Scripts -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
{% endblock %}

{% block scripts %}
<script>
    // Wait for DOM to load
    document.addEventListener('DOMContentLoaded', function() {
        // Theme management
        const themeToggle = document.getElementById('themeToggle');
        const currentTheme = localStorage.getItem('theme') || 'light';
        
        // Apply saved theme
        document.documentElement.setAttribute('data-theme', currentTheme);
        
        if (themeToggle) {
            themeToggle.addEventListener('click', function() {
                const theme = document.documentElement.getAttribute('data-theme');
                const newTheme = theme === 'dark' ? 'light' : 'dark';
                
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                
                // Reinitialize chart with new theme colors
                if (window.chartInstance) {
                    setTimeout(() => {
                        initializeProfitChart();
                    }, 100);
                }
            });
        }
        // Check if required libraries are loaded
        function checkLibrariesLoaded() {
            const libraries = {
                'Chart.js': typeof Chart !== 'undefined',
                'jsPDF': typeof window.jsPDF !== 'undefined',
                'html2canvas': typeof html2canvas !== 'undefined'
            };
            
            const missing = Object.entries(libraries).filter(([name, loaded]) => !loaded);
            if (missing.length > 0) {
                console.warn('Missing libraries:', missing.map(([name]) => name));
                // Still try to initialize chart with basic functionality
            }
            
            return libraries;
        }
        
        // Wait for scripts to load and check libraries
        setTimeout(function() {
            const libStatus = checkLibrariesLoaded();
            console.log('Library status:', libStatus);
            initializeProfitChart();
        }, 1000);
        
        // Time selector functionality
        const timeButtons = document.querySelectorAll('.time-btn');
        console.log('Found time buttons:', timeButtons.length);
        timeButtons.forEach(button => {
            button.addEventListener('click', function() {
                console.log('Time button clicked:', this.getAttribute('data-range'));
                const timeRange = this.getAttribute('data-range');
                if (timeRange) {
                    const url = new URL(window.location);
                    url.searchParams.set('time_range', timeRange);
                    console.log('Navigating to:', url.toString());
                    window.location.href = url.toString();
                }
            });
        });

        // Refresh button functionality
        const refreshBtn = document.getElementById('refreshBtn');
        console.log('Refresh button found:', !!refreshBtn);
        if (refreshBtn) {
            refreshBtn.addEventListener('click', function() {
                console.log('Refresh button clicked');
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fas fa-sync-alt"></i> Refreshing...';
                this.disabled = true;
                this.classList.add('loading');

                // Reload the page with current time range
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            });
        } else {
            console.error('Refresh button not found');
        }

        // Enhanced Chart export functionality
        const exportChartBtn = document.getElementById('export-chart');
        console.log('Export chart button found:', !!exportChartBtn);
        if (exportChartBtn) {
            exportChartBtn.addEventListener('click', function() {
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
                this.disabled = true;

                setTimeout(function() {
                    const canvas = document.getElementById('profitChart');
                    if (canvas && typeof canvas.toDataURL === 'function') {
                        try {
                            const link = document.createElement('a');
                            const currentDate = new Date().toISOString().split('T')[0];
                            link.download = `profit-analysis-chart-${currentDate}.png`;
                            link.href = canvas.toDataURL('image/png', 1.0);
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            
                            // Success feedback
                            exportChartBtn.innerHTML = '<i class="fas fa-check"></i> Exported!';
                            setTimeout(() => {
                                exportChartBtn.innerHTML = originalText;
                                exportChartBtn.disabled = false;
                            }, 2000);
                        } catch (error) {
                            console.error('Chart export failed:', error);
                            // Fallback: export the entire report as PDF
                            exportFullReportAsPDF();
                            exportChartBtn.innerHTML = '<i class="fas fa-check"></i> Report Exported!';
                            setTimeout(() => {
                                exportChartBtn.innerHTML = originalText;
                                exportChartBtn.disabled = false;
                            }, 2000);
                        }
                    } else {
                        console.log('Chart not available, exporting full report instead');
                        // Fallback: export the entire report as PDF
                        exportFullReportAsPDF();
                        exportChartBtn.innerHTML = '<i class="fas fa-check"></i> Report Exported!';
                        setTimeout(() => {
                            exportChartBtn.innerHTML = originalText;
                            exportChartBtn.disabled = false;
                        }, 2000);
                    }
                }, 100);
            });
        }

        // Enhanced Chart print functionality
        const printChartBtn = document.getElementById('print-chart');
        console.log('Print chart button found:', !!printChartBtn);
        if (printChartBtn) {
            printChartBtn.addEventListener('click', function() {
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Preparing...';
                this.disabled = true;

                setTimeout(function() {
                    const canvas = document.getElementById('profitChart');
                    if (canvas && typeof canvas.toDataURL === 'function') {
                        try {
                            const dataUrl = canvas.toDataURL('image/png', 1.0);
                            const currentDate = new Date().toLocaleDateString();
                            
                            const printContent = `
                                <!DOCTYPE html>
                                <html>
                                    <head>
                                        <title>Profit Analysis Chart - ${currentDate}</title>
                                        <style>
                                            @media print { @page { margin: 1in; } }
                                            body { 
                                                text-align: center; 
                                                margin: 0;
                                                padding: 20px;
                                                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                                                background: white;
                                            } 
                                            .header {
                                                margin-bottom: 30px;
                                            }
                                            h1 {
                                                color: #2c3e50;
                                                margin-bottom: 10px;
                                                font-size: 24px;
                                            }
                                            .date {
                                                color: #7f8c8d;
                                                font-size: 16px;
                                                margin-bottom: 20px;
                                            }
                                            img { 
                                                max-width: 100%; 
                                                height: auto; 
                                                border: 2px solid #eee;
                                                border-radius: 8px;
                                                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                                            }
                                            .footer {
                                                margin-top: 30px;
                                                font-size: 12px;
                                                color: #95a5a6;
                                            }
                                        </style>
                                    </head>
                                    <body>
                                        <div class="header">
                                            <h1>Profit Analysis Chart</h1>
                                            <div class="date">Generated on: ${currentDate}</div>
                                        </div>
                                        <img src="${dataUrl}" alt="Profit Analysis Chart">
                                        <div class="footer">
                                            <p>Revenue vs. Profit Analysis Dashboard</p>
                                        </div>
                                        <script>
                                            window.onload = function() {
                                                setTimeout(function() {
                                                    window.print();
                                                    setTimeout(function() {
                                                        window.close();
                                                    }, 1000);
                                                }, 500);
                                            };
                                        <\/script>
                                    </body>
                                </html>
                            `;
                            
                            const printWindow = window.open('', '_blank', 'width=800,height=600');
                            if (printWindow) {
                                printWindow.document.write(printContent);
                                printWindow.document.close();
                                
                                // Success feedback
                                printChartBtn.innerHTML = '<i class="fas fa-check"></i> Print Ready!';
                                setTimeout(() => {
                                    printChartBtn.innerHTML = originalText;
                                    printChartBtn.disabled = false;
                                }, 2000);
                            } else {
                                alert('Popup blocked. Please allow popups for this site and try again.');
                                printChartBtn.innerHTML = originalText;
                                printChartBtn.disabled = false;
                            }
                        } catch (error) {
                            console.error('Chart print failed:', error);
                            // Fallback: print the entire report
                            window.print();
                            printChartBtn.innerHTML = '<i class="fas fa-check"></i> Report Printed!';
                            setTimeout(() => {
                                printChartBtn.innerHTML = originalText;
                                printChartBtn.disabled = false;
                            }, 2000);
                        }
                    } else {
                        console.log('Chart not available, printing full report instead');
                        // Fallback: print the entire report
                        window.print();
                        printChartBtn.innerHTML = '<i class="fas fa-check"></i> Report Printed!';
                        setTimeout(() => {
                            printChartBtn.innerHTML = originalText;
                            printChartBtn.disabled = false;
                        }, 2000);
                    }
                }, 100);
            });
        }

        // Helper function for PDF export fallback
        function exportFullReportAsPDF() {
            try {
                // Check if required libraries are available
                if (typeof window.jsPDF === 'undefined' || typeof html2canvas === 'undefined') {
                    console.warn('PDF generation libraries not loaded, falling back to print');
                    window.print();
                    return;
                }

                const element = document.querySelector('.profit-analysis-container');
                if (!element) {
                    throw new Error('Could not find report content to export');
                }

                // Create a clone for PDF generation (to avoid modifying original)
                const clone = element.cloneNode(true);
                
                // Remove interactive elements from clone
                const elementsToRemove = clone.querySelectorAll('.time-selector, .chart-controls, .actions, .theme-toggle, .refresh-btn');
                elementsToRemove.forEach(el => el.remove());
                
                // Temporarily add clone to document for html2canvas
                clone.style.position = 'absolute';
                clone.style.left = '-9999px';
                clone.style.background = 'white';
                clone.style.color = 'black';
                document.body.appendChild(clone);

                // Generate canvas from HTML
                html2canvas(clone, {
                    scale: 1.5,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    logging: false
                }).then(canvas => {
                    // Remove clone
                    document.body.removeChild(clone);

                    // Create PDF
                    const { jsPDF } = window.jsPDF;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    
                    // Calculate dimensions
                    const imgWidth = 210; // A4 width in mm
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    const pageHeight = 297; // A4 height in mm
                    
                    let heightLeft = imgHeight;
                    let position = 0;

                    // Add image to PDF (handle multiple pages if needed)
                    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    // Save the PDF
                    const currentDate = new Date().toISOString().split('T')[0];
                    pdf.save(`profit-analysis-report-${currentDate}.pdf`);
                }).catch(error => {
                    console.error('Canvas generation failed:', error);
                    // Final fallback: print dialog
                    window.print();
                });
            } catch (error) {
                console.error('PDF generation failed:', error);
                // Final fallback: print dialog
                window.print();
            }
        }

        // Enhanced Full report export functionality using jsPDF
        const exportBtn = document.getElementById('exportButton');
        console.log('Export button found:', !!exportBtn);
        if (exportBtn) {
            exportBtn.addEventListener('click', async function() {
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
                this.disabled = true;

                try {
                    // Check if libraries are available
                    if (typeof window.jsPDF === 'undefined' || typeof html2canvas === 'undefined') {
                        console.log('PDF libraries not available, using print fallback');
                        this.innerHTML = '<i class="fas fa-print"></i> Opening Print Dialog...';
                        setTimeout(() => {
                            window.print();
                            this.innerHTML = originalText;
                            this.disabled = false;
                        }, 500);
                        return;
                    }
                    
                    exportFullReportAsPDF();
                    
                    // Success feedback
                    this.innerHTML = '<i class="fas fa-check"></i> PDF Generated!';
                    setTimeout(() => {
                        this.innerHTML = originalText;
                        this.disabled = false;
                    }, 2000);

                } catch (error) {
                    console.error('PDF generation failed:', error);
                    
                    // Fallback to print dialog
                    this.innerHTML = '<i class="fas fa-print"></i> Opening Print Dialog...';
                    setTimeout(() => {
                        window.print();
                        this.innerHTML = originalText;
                        this.disabled = false;
                    }, 1000);
                }
            });
        }

        // Enhanced Full report print functionality
        const printBtn = document.getElementById('printButton');
        console.log('Print button found:', !!printBtn);
        if (printBtn) {
            printBtn.addEventListener('click', function() {
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Preparing...';
                this.disabled = true;

                setTimeout(() => {
                    window.print();
                    
                    // Success feedback
                    this.innerHTML = '<i class="fas fa-check"></i> Print Dialog Opened!';
                    setTimeout(() => {
                        this.innerHTML = originalText;
                        this.disabled = false;
                    }, 2000);
                }, 500);
            });
        }

        // Update date display for today's sold items
        updateDateDisplay();
        
        // Test button functionality
        console.log('Button elements found:');
        console.log('- Theme toggle:', document.getElementById('themeToggle'));
        console.log('- Refresh button:', document.getElementById('refreshBtn'));
        console.log('- Time buttons:', document.querySelectorAll('.time-btn').length);
        console.log('- Export chart button:', document.getElementById('export-chart'));
        console.log('- Print chart button:', document.getElementById('print-chart'));
        console.log('- Export button:', document.getElementById('exportButton'));
        console.log('- Print button:', document.getElementById('printButton'));
        
        // Add simple test click handlers to verify buttons are working
        const allButtons = document.querySelectorAll('button');
        console.log('Total buttons found:', allButtons.length);
        allButtons.forEach((btn, index) => {
            console.log(`Button ${index}:`, btn.id || btn.className, btn.textContent.trim());
        });
    });

    let chartInstance = null;

    function initializeProfitChart() {
        // Check if Chart.js is available
        if (typeof Chart === 'undefined') {
            console.error("Chart.js library not loaded");
            displayChartError("Chart library not available. Please refresh the page or check your internet connection.");
            return;
        }
        
        const chartDataElement = document.getElementById('chart-data');
        if (!chartDataElement) {
            console.error("Chart data element not found");
            displayChartError("Chart data element not found");
            return;
        }

        const rawData = chartDataElement.dataset.chart;
        if (!rawData || rawData === '{}') {
            console.error("No chart data found or empty data");
            displayChartError("No chart data available - this is normal if there are no sales in the selected period");
            return;
        }
        
        let chartData;
        try {
            chartData = JSON.parse(rawData);
            console.log("Parsed chart data:", chartData);
        } catch (error) {
            console.error("Error parsing chart data:", error);
            displayChartError("Error parsing chart data");
            return;
        }

        if (!chartData || typeof chartData !== 'object') {
            console.error("Invalid chart data structure");
            displayChartError("Invalid chart data structure");
            return;
        }
        
        const ctx = document.getElementById('profitChart');
        if (!ctx) {
            console.error("Chart canvas element not found");
            displayChartError("Chart canvas element not found");
            return;
        }

        const context = ctx.getContext('2d');
        if (!context) {
            console.error("Could not get 2D context from canvas");
            displayChartError("Could not initialize chart context");
            return;
        }
        
        const dates = chartData.dates || [];
        const profits = chartData.profits || [];
        const sales = chartData.sales || [];
        const expenses = chartData.expenses || [];

        // Check if we have any data to display
        const hasData = dates.length > 0 && (profits.some(p => p > 0) || sales.some(s => s > 0) || expenses.some(e => e > 0));
        if (!hasData) {
            console.log("No data to display in chart");
            displayChartError("No sales data available for the selected period");
            return;
        }

        // Get theme-aware colors
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const textColor = isDark ? '#ffffff' : '#333333';
        const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)';

        try {
            // Destroy existing chart if it exists
            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(context, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Profit',
                            data: profits,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.3,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            pointBackgroundColor: '#3498db',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2
                        },
                        {
                            label: 'Sales',
                            data: sales,
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.3,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            pointBackgroundColor: '#2ecc71',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2
                        },
                        {
                            label: 'Expenses',
                            data: expenses,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.3,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            pointBackgroundColor: '#e74c3c',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14,
                                    family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
                                },
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle',
                                color: textColor
                            }
                        },
                        tooltip: {
                            backgroundColor: isDark ? 'rgba(45, 49, 66, 0.9)' : 'rgba(0, 0, 0, 0.8)',
                            titleFont: {
                                size: 16
                            },
                            bodyFont: {
                                size: 14
                            },
                            padding: 12,
                            displayColors: true,
                            borderColor: isDark ? '#404040' : '#eaeaea',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': KES ' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: gridColor
                            },
                            ticks: {
                                callback: function(value) {
                                    return 'KES ' + value.toLocaleString();
                                },
                                font: {
                                    size: 12
                                },
                                color: textColor
                            },
                            title: {
                                display: true,
                                text: 'Amount (KES)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                color: textColor
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 12
                                },
                                color: textColor
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    hover: {
                        mode: 'index',
                        intersect: false
                    }
                }
            });

            console.log("Chart initialized successfully");
            window.chartInstance = chartInstance;
        } catch (error) {
            console.error("Error creating chart:", error);
            displayChartError("Error creating chart: " + error.message);
        }
    }

    function displayChartError(message) {
        const container = document.querySelector('.chart-wrapper');
        if (container) {
            container.innerHTML = `
                <div class="chart-error">
                    <i class="fas fa-info-circle"></i>
                    <h3>Chart Information</h3>
                    <p>${message}</p>
                    <p><strong>Note:</strong> You can still use the Print and Export buttons to generate reports with the available data.</p>
                </div>
            `;
        }
    }

    // Update date display for today's sold items
    function updateDateDisplay() {
        const dateElement = document.getElementById('todays-date-display');
        if (dateElement && dateElement.textContent === 'Today') {
            const today = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            dateElement.textContent = today.toLocaleDateString('en-US', options);
        }
    }
</script>
{% endblock %}